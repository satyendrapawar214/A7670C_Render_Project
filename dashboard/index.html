<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A7670C ThingSpeak HTTP Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; background:#0f1214; color:#e0e0e0; padding:20px; }
    .container { max-width:1200px; margin:auto; }
    .header { background:#1c1f24; padding:20px; border-radius:10px; border-left:5px solid #34a853; }
    .chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; margin-top:20px; }
    .chart-card { background:#1c1f24; padding:20px; border-radius:10px; }
    #debug-log { background:#000; color:#00ff41; padding:15px; height:160px; overflow:auto; margin-top:20px; }
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2>A7670C Live GPS Dashboard (HTTP)</h2>
    <p>Status: <span id="status">Initializing...</span></p>
  </div>

  <div class="chart-grid">
    <div class="chart-card"><canvas id="latChart"></canvas></div>
    <div class="chart-card"><canvas id="lonChart"></canvas></div>
    <div class="chart-card"><canvas id="speedChart"></canvas></div>
    <div class="chart-card"><canvas id="timeChart"></canvas></div>
  </div>

  <h3>Live Log</h3>
  <div id="debug-log"></div>
</div>

<script>
const CHANNEL_ID = "3196559";
const READ_API_KEY = "Q2OIEIS8P8NCLHX2";

const statusDiv = document.getElementById("status");
const logDiv = document.getElementById("debug-log");

function log(msg){
  logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logDiv.innerHTML;
}

function initChart(id, label, color){
  return new Chart(document.getElementById(id), {
    type:'line',
    data:{ labels:[], datasets:[{ label, data:[], borderColor:color, fill:false }]},
    options:{ responsive:true }
  });
}

const charts = {
  lat: initChart("latChart","Latitude","#4285f4"),
  lon: initChart("lonChart","Longitude","#34a853"),
  speed: initChart("speedChart","Speed (km/h)","#ea4335"),
  time: initChart("timeChart","Time (Human)","#fbbc05")
};

function update(chart, value){
  chart.data.labels.push(new Date().toLocaleTimeString());
  chart.data.datasets[0].data.push(value);
  if(chart.data.labels.length > 20){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

async function fetchData(){
  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=1`;

  try{
    const res = await fetch(url);
    const json = await res.json();
    const f = json.feeds[0];

    statusDiv.innerText = "Connected";
    statusDiv.style.color = "lightgreen";

    // Field mapping
    if(f.field1) update(charts.lat, parseFloat(f.field1));
    if(f.field2) update(charts.lon, parseFloat(f.field2));
    if(f.field3) update(charts.speed, parseFloat(f.field3));
    if(f.field4){
      const humanTime = new Date(f.field4 * 1000).toLocaleTimeString();
      update(charts.time, f.field4);
      log(`Lat:${f.field1} Lon:${f.field2} Speed:${f.field3} Time:${humanTime}`);
    }

  }catch(e){
    statusDiv.innerText = "Error";
    statusDiv.style.color = "red";
    log("Fetch error");
  }
}

log("Dashboard started...");
fetchData();
setInterval(fetchData,15000);
</script>
</body>
</html>
