<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>A7670C ThingSpeak Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    .header { background: #1f1f1f; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #34a853; }
    #status { font-weight: bold; color: #ff9800; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 15px; }
    .chart-card { background: #1f1f1f; padding: 15px; border-radius: 10px; border: 1px solid #333; }
    #debug-log { background: #000; color: #00ff00; padding: 15px; height: 180px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; border-radius: 5px; margin-top: 20px; border: 1px solid #444; }
    .log-entry { border-bottom: 1px solid #222; padding: 3px 0; }
  </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>A7670C ThingSpeak Monitor</h1>
        <p>Status: <span id="status">Connecting to ThingSpeak...</span></p>
    </div>

    <div class="chart-grid">
        <div class="chart-card"><canvas id="latChart"></canvas></div>
        <div class="chart-card"><canvas id="lonChart"></canvas></div>
        <div class="chart-card"><canvas id="speedChart"></canvas></div>
        <div class="chart-card"><canvas id="batteryChart"></canvas></div>
    </div>

    <h3>ThingSpeak MQTT Log</h3>
    <div id="debug-log"></div>
</div>

<script>
// --- THINGSPEAK CONFIGURATION ---
const CHANNEL_ID = "YOUR_CHANNEL_ID"; // Replace with your Channel ID
const MQTT_API_KEY = "YOUR_MQTT_API_KEY"; // Replace with your MQTT API Key

// ThingSpeak uses WebSockets on Port 443 (standard HTTPS port)
const brokerUrl = "wss://mqtt3.thingspeak.com:443/mqtt"; 

const options = {
    username: "ANY_STRING", // Usually doesn't matter for ThingSpeak MQTT
    password: MQTT_API_KEY,
    clientId: "YOUR_CLIENT_ID", // MUST match the Client ID generated in ThingSpeak
    clean: true
};

const statusDiv = document.getElementById("status");
const debugLog = document.getElementById("debug-log");

function log(msg) {
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    debugLog.prepend(entry);
}

const client = mqtt.connect(brokerUrl, options);

// --- CHART INITIALIZATION ---
function initChart(id, label, unit, color) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: `${label} (${unit})`, data: [], borderColor: color, tension: 0.3, fill: false }] },
        options: { responsive: true, scales: { y: { grid: { color: '#333' } }, x: { display: false } } }
    });
}

const charts = {
    lat: initChart('latChart', 'Latitude', 'deg', '#4285f4'),
    lon: initChart('lonChart', 'Longitude', 'deg', '#34a853'),
    speed: initChart('speedChart', 'Speed', 'km/h', '#ea4335'),
    bat: initChart('batteryChart', 'Battery', 'V', '#00e676')
};

client.on("connect", () => {
    log("CONNECTED to ThingSpeak!");
    statusDiv.innerText = "Online";
    statusDiv.style.color = "#4caf50";
    // ThingSpeak subscribe topic format
    client.subscribe(`channels/${CHANNEL_ID}/subscribe`);
});

client.on("message", (topic, message) => {
    const raw = message.toString();
    log(`Data Received: ${raw}`);
    
    // ThingSpeak usually sends data as: field1=18.5&field2=73.2...
    // But if you send JSON, we parse it here:
    try {
        const urlParams = new URLSearchParams(raw);
        if (urlParams.has('field1')) updateChart(charts.lat, urlParams.get('field1'));
        if (urlParams.has('field2')) updateChart(charts.lon, urlParams.get('field2'));
        if (urlParams.has('field3')) updateChart(charts.speed, urlParams.get('field3'));
        if (urlParams.has('field4')) updateChart(charts.bat, urlParams.get('field4'));
    } catch(e) {
        log("Parse Error: Ensure data is sent as field1=val&field2=val");
    }
});

function updateChart(chart, val) {
    const time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update('none');
}
</script>
</body>
</html>
