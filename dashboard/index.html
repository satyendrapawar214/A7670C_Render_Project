<script>
// --- THINGSPEAK HTTP CONFIGURATION ---
const CHANNEL_ID = "3197097"; 
const READ_API_KEY = "YOUR_READ_API_KEY"; // Get this from ThingSpeak 'API Keys' tab

const statusDiv = document.getElementById("status");
const debugLog = document.getElementById("debug-log");

function log(msg) {
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    debugLog.prepend(entry);
}

// --- CHART INITIALIZATION ---
function initChart(id, label, unit, color) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: `${label} (${unit})`, data: [], borderColor: color, tension: 0.3, fill: false }] },
        options: { responsive: true, scales: { y: { grid: { color: '#333' } }, x: { display: false } } }
    });
}

const charts = {
    lat: initChart('latChart', 'Latitude', 'deg', '#4285f4'),
    lon: initChart('lonChart', 'Longitude', 'deg', '#34a853'),
    speed: initChart('speedChart', 'Speed', 'km/h', '#ea4335'),
    bat: initChart('batteryChart', 'Battery', 'V', '#00e676')
};

// --- HTTP FETCH LOGIC ---
async function fetchData() {
    // API URL to get the last 1 entry from your channel
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=1`;

    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.feeds && data.feeds.length > 0) {
            const lastEntry = data.feeds[0];
            statusDiv.innerText = "Online: Syncing Data";
            statusDiv.style.color = "#4caf50";

            log(`Data Received: F1:${lastEntry.field1}, F2:${lastEntry.field2}`);

            // Update charts if data exists in fields
            if (lastEntry.field1 !== null) updateChart(charts.lat, lastEntry.field1);
            if (lastEntry.field2 !== null) updateChart(charts.lon, lastEntry.field2);
            if (lastEntry.field3 !== null) updateChart(charts.speed, lastEntry.field3);
            if (lastEntry.field4 !== null) updateChart(charts.bat, lastEntry.field4);
        }
    } catch (error) {
        log("HTTP Fetch Error: Check your Read API Key or Network.");
        statusDiv.innerText = "Fetch Error";
        statusDiv.style.color = "#ff5252";
    }
}

function updateChart(chart, val) {
    const time = new Date().toLocaleTimeString();
    // Don't add duplicate data if it hasn't changed (optional)
    if (chart.data.datasets[0].data.slice(-1)[0] === val) return; 

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}

// Start polling every 15 seconds (ThingSpeak free tier limit)
log("Starting HTTP Polling...");
fetchData(); 
setInterval(fetchData, 15000); 

</script>
