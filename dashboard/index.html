<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>A7670C Live Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    .header { background: #1f1f1f; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #1a73e8; }
    #status { font-weight: bold; color: #ff9800; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
    .chart-card { background: #1f1f1f; padding: 15px; border-radius: 10px; border: 1px solid #333; }
    #debug-log { background: #000; color: #00ff00; padding: 15px; height: 200px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; border-radius: 5px; margin-top: 20px; border: 1px solid #444; }
    .log-entry { border-bottom: 1px solid #222; padding: 3px 0; }
    .err { color: #ff5252; }
  </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>A7670C IoT Telemetry</h1>
        <p>Status: <span id="status">Connecting to Broker...</span></p>
    </div>

    <div class="chart-grid">
        <div class="chart-card"><canvas id="latChart"></canvas></div>
        <div class="chart-card"><canvas id="lonChart"></canvas></div>
        <div class="chart-card"><canvas id="speedChart"></canvas></div>
        <div class="chart-card"><canvas id="tempChart"></canvas></div>
        <div class="chart-card"><canvas id="voltageChart"></canvas></div>
    </div>

    <h3>System Output Log</h3>
    <div id="debug-log"></div>
</div>

<script>
// --- UPDATED CONFIGURATION ---
// Note: Ensure your EMQX Cloud has a WSS listener on 8084
const brokerUrl = "wss://y17601f1.ala.dedicated.aws.emqxcloud.com:8084/";
const options = {
    username: "satyendrapawar", 
    password: "Satyendra@123",
    clientId: 'web_' + Math.random().toString(16).substring(2, 10),
    connectTimeout: 15000,
    keepalive: 60,
    clean: true,
    reconnectPeriod: 1000,
};

const statusDiv = document.getElementById("status");
const debugLog = document.getElementById("debug-log");

function log(msg, isError = false) {
    const entry = document.createElement("div");
    entry.className = isError ? "log-entry err" : "log-entry";
    entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    debugLog.prepend(entry);
}

log("Connecting to: " + brokerUrl);
const client = mqtt.connect(brokerUrl, options);

// --- CHART INITIALIZATION ---
function initChart(id, label, unit, color) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: `${label} (${unit})`, data: [], borderColor: color, tension: 0.3, fill: false }] },
        options: {
            responsive: true,
            scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } },
            plugins: { legend: { labels: { color: '#fff' } } }
        }
    });
}

const charts = {
    lat: initChart('latChart', 'Lat', 'deg', '#4285f4'),
    lon: initChart('lonChart', 'Lon', 'deg', '#34a853'),
    speed: initChart('speedChart', 'Speed', 'km/h', '#ea4335'),
    temp: initChart('tempChart', 'Temp', 'Â°C', '#fbbc05'),
    volt: initChart('voltageChart', 'Voltage', 'V', '#a142f4')
};

// --- EVENT HANDLERS ---
client.on("connect", () => {
    log("CONNECTED to EMQX Cloud");
    statusDiv.innerText = "Online - Waiting for Data";
    statusDiv.style.color = "#4caf50";
    client.subscribe(["a7670c/data", "a7670c/gps"]);
});

client.on("error", (err) => {
    log("MQTT Error: " + err.message, true);
    statusDiv.innerText = "Connection Failed";
    statusDiv.style.color = "#ff5252";
});

client.on("message", (topic, message) => {
    const raw = message.toString();
    log(`Topic: ${topic} | Data: ${raw}`);
    
    try {
        const data = JSON.parse(raw);
        if(topic === "a7670c/gps") {
            if(data.lat) updateChart(charts.lat, data.lat);
            if(data.lon) updateChart(charts.lon, data.lon);
            if(data.speed !== undefined) updateChart(charts.speed, data.speed);
        } else {
            if(data.temp) updateChart(charts.temp, data.temp);
            if(data.volt || data.voltage) updateChart(charts.volt, data.volt || data.voltage);
        }
    } catch(e) {
        log("JSON Parse Error: Check if hardware sends valid JSON format.", true);
    }
});

function updateChart(chart, val) {
    const time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}
</script>
</body>
</html>
